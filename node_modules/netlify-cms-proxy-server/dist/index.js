#!/usr/bin/env node
module.exports=function(e){var t={};function a(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,a),i.l=!0,i.exports}return a.m=e,a.c=t,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(r,i,function(t){return e[t]}.bind(null,i));return r},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=19)}([function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs")},function(e,t,a){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.joi=t.defaultSchema=void 0;const i=r(a(3)),s=["info","entriesByFolder","entriesByFiles","getEntry","unpublishedEntries","unpublishedEntry","unpublishedEntryDataFile","unpublishedEntryMediaFile","deleteUnpublishedEntry","persistEntry","updateUnpublishedEntryStatus","publishUnpublishedEntry","getMedia","getMediaFile","persistMedia","deleteFile","getDeployPreview"],n=i.default.string().required(),o=i.default.number().required(),l=i.default.bool().required(),c=n,u=n;t.defaultSchema=({path:e=n}={})=>{const t=i.default.object({branch:n}),a=i.default.object({path:e,content:n,encoding:n.valid("base64")}),r=i.default.when("action",{switch:[{is:"info",then:i.default.allow()},{is:"entriesByFolder",then:t.keys({folder:e,extension:n,depth:o}).required()},{is:"entriesByFiles",then:t.keys({files:i.default.array().items(i.default.object({path:e,label:i.default.string()})).required()})},{is:"getEntry",then:t.keys({path:e}).required()},{is:"unpublishedEntries",then:t.keys({branch:n}).required()},{is:"unpublishedEntry",then:t.keys({id:i.default.string().optional(),collection:i.default.string().optional(),slug:i.default.string().optional()}).required()},{is:"unpublishedEntryDataFile",then:t.keys({collection:c,slug:u,id:n,path:n}).required()},{is:"unpublishedEntryMediaFile",then:t.keys({collection:c,slug:u,id:n,path:n}).required()},{is:"deleteUnpublishedEntry",then:t.keys({collection:c,slug:u}).required()},{is:"persistEntry",then:t.keys({entry:i.default.object({slug:n,path:e,raw:n,newPath:e.optional()}).required(),assets:i.default.array().items(a).required(),options:i.default.object({collectionName:i.default.string(),commitMessage:n,useWorkflow:l,status:n}).required()}).required()},{is:"updateUnpublishedEntryStatus",then:t.keys({collection:c,slug:u,newStatus:n}).required()},{is:"publishUnpublishedEntry",then:t.keys({collection:c,slug:u}).required()},{is:"getMedia",then:t.keys({mediaFolder:e}).required()},{is:"getMediaFile",then:t.keys({path:e}).required()},{is:"persistMedia",then:t.keys({asset:a.required(),options:i.default.object({commitMessage:n}).required()}).required()},{is:"deleteFile",then:t.keys({path:e,options:i.default.object({commitMessage:n}).required()}).required()},{is:"getDeployPreview",then:t.keys({collection:c,slug:u}).required()}],otherwise:i.default.forbidden()});return i.default.object({action:i.default.valid(...s).required(),params:r})},t.joi=e=>(t,a,r)=>{const{error:i}=e.validate(t.body,{allowUnknown:!0});if(i){const{details:e}=i,t=e.map(e=>e.message).join(",");a.status(422).json({error:t})}else r()}},function(e,t){e.exports=require("@hapi/joi")},function(e,t,a){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.pathTraversal=void 0;const i=r(a(3)),s=r(a(0));t.pathTraversal=e=>i.default.extend({type:"path",base:i.default.string().required(),messages:{"path.invalid":"{{#label}} must resolve to a path under the configured repository"},validate(t,a){if(!s.default.join(e,t).startsWith(e))return{value:t,errors:a.error("path.invalid")}}}).path()},function(e,t,a){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.move=t.deleteFile=t.writeFile=t.listRepoFiles=void 0;const i=r(a(0)),s=a(1),n=async(e,t,a)=>{if(a<=0)return[];try{const r=await s.promises.readdir(e,{withFileTypes:!0}),o=await Promise.all(r.map(r=>{const s=i.default.join(e,r.name);return r.isDirectory()?n(s,t,a-1):[s].filter(e=>e.endsWith(t))}));return[].concat(...o)}catch(e){return[]}};t.listRepoFiles=async(e,t,a,r)=>(await n(i.default.join(e,t),a,r)).map(t=>t.substr(e.length+1)),t.writeFile=async(e,t)=>{await s.promises.mkdir(i.default.dirname(e),{recursive:!0}),await s.promises.writeFile(e,t)},t.deleteFile=async(e,t)=>{await s.promises.unlink(i.default.join(e,t))};const o=async(e,t)=>{await s.promises.mkdir(i.default.dirname(t),{recursive:!0}),await s.promises.rename(e,t)};t.move=async(e,t)=>{await o(e,t);const a=i.default.dirname(e),r=i.default.dirname(t),s=await n(a,"",100);await Promise.all(s.map(e=>o(e,e.replace(a,r))))}},function(e,t,a){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.readMediaFile=t.entriesFromFiles=void 0;const i=r(a(15)),s=r(a(0)),n=a(1),o=e=>i.default.createHash("sha256").update(e).digest("hex"),l=e=>e.replace(/\\/g,"/");t.entriesFromFiles=async(e,t)=>Promise.all(t.map(async t=>{try{const a=await n.promises.readFile(s.default.join(e,t.path));return{data:a.toString(),file:{path:l(t.path),label:t.label,id:o(a)}}}catch(e){return{data:null,file:{path:l(t.path),label:t.label,id:null}}}})),t.readMediaFile=async(e,t)=>{const a=await n.promises.readFile(s.default.join(e,t));return{id:o(a),content:a.toString("base64"),encoding:"base64",path:l(t),name:s.default.basename(t)}}},function(e,t){e.exports=require("express")},function(e,t,a){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.registerCommonMiddlewares=void 0;const i=r(a(7)),s=r(a(9)),n=r(a(10));t.registerCommonMiddlewares=(e,t)=>{const{logger:a}=t,r={write:e=>{a.debug(String(e).trim())}};e.use(s.default("combined",{stream:r})),e.use(n.default()),e.use(i.default.json({limit:"50mb"}))}},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("cors")},function(e,t,a){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.registerMiddleware=t.localGitMiddleware=t.getSchema=t.validateRepo=void 0;const i=r(a(0)),s=a(1),n=a(12),o=a(13),l=a(2),c=r(a(14)),u=a(4),d=a(5),p=a(6),f=async(e,t)=>{await e.add("."),await e.commit(t,void 0,{"--no-verify":!0,"--no-gpg-sign":!0})},h=async e=>await e.branchLocal().then(e=>e.current),m=async(e,t,a)=>{const r=await h(e);try{r!==t&&await e.checkout(t);return await a()}finally{await e.checkout(r)}},y=e=>`branch.${e}.description`,g=async(e,t,a,r,s)=>{await d.writeFile(i.default.join(t,a.path),a.raw),await Promise.all(r.map(e=>d.writeFile(i.default.join(t,e.path),Buffer.from(e.content,e.encoding)))),a.newPath&&await d.move(i.default.join(t,a.path),i.default.join(t,a.newPath)),await f(e,s)},w=async(e,t)=>await e.branchLocal().then(({all:e})=>e.includes(t)),b=async(e,t,a)=>{const r=await e.diff([t,a]);return o.parse(r).map(e=>{var t,a;const r=(null===(t=e.oldPath)||void 0===t?void 0:t.replace(/b\//,""))||"",i=(null===(a=e.newPath)||void 0===a?void 0:a.replace(/b\//,""))||"",s=i||r;return{oldPath:r,newPath:i,status:e.status,newFile:"added"===e.status,path:s,id:s,binary:e.binary||/.svg$/.test(s)}})};t.validateRepo=async({repoPath:e})=>{const t=c.default(e).silent(!1);if(!await t.checkIsRepo())throw Error(e+" is not a valid git repository")},t.getSchema=({repoPath:e})=>l.defaultSchema({path:u.pathTraversal(e)}),t.localGitMiddleware=({repoPath:e,logger:t})=>{const a=c.default(e).silent(!1);return async function(r,o){try{const{body:t}=r;if("info"===t.action)return void o.json({repo:i.default.basename(e),publish_modes:["simple","editorial_workflow"],type:"local_git"});const{branch:l}=t.params;if(!await w(a,l)){const e=`Default branch '${l}' doesn't exist`;return void o.status(422).json({error:e})}switch(t.action){case"entriesByFolder":{const r=t.params,{folder:i,extension:s,depth:n}=r,c=await m(a,l,()=>d.listRepoFiles(e,i,s,n).then(t=>p.entriesFromFiles(e,t.map(e=>({path:e})))));o.json(c);break}case"entriesByFiles":{const r=t.params,i=await m(a,l,()=>p.entriesFromFiles(e,r.files));o.json(i);break}case"getEntry":{const r=t.params,[i]=await m(a,l,()=>p.entriesFromFiles(e,[{path:r.path}]));o.json(i);break}case"unpublishedEntries":{const e=await a.branchLocal().then(e=>e.all.filter(e=>e.startsWith(n.CMS_BRANCH_PREFIX+"/")));o.json(e.map(n.contentKeyFromBranch));break}case"unpublishedEntry":{let{id:e,collection:r,slug:i}=t.params;e&&({collection:r,slug:i}=n.parseContentKey(e));const s=n.generateContentKey(r,i),c=n.branchFromContentKey(s);if(!await w(a,c))return o.status(404).json({message:"Not Found"});{const e=await b(a,l,c),t=await a.raw(["config",y(c)]),s={collection:r,slug:i,status:t&&n.labelToStatus(t.trim()),diffs:e};o.json(s)}break}case"unpublishedEntryDataFile":{const{path:r,collection:i,slug:s}=t.params,l=n.generateContentKey(i,s),c=n.branchFromContentKey(l),[u]=await m(a,c,()=>p.entriesFromFiles(e,[{path:r}]));o.json({data:u.data});break}case"unpublishedEntryMediaFile":{const{path:r,collection:i,slug:s}=t.params,l=n.generateContentKey(i,s),c=n.branchFromContentKey(l),u=await m(a,c,()=>p.readMediaFile(e,r));o.json(u);break}case"deleteUnpublishedEntry":{const{collection:e,slug:r}=t.params,i=n.generateContentKey(e,r),s=n.branchFromContentKey(i);await h(a)===s&&await a.checkoutLocalBranch(l),await a.branch(["-D",s]),o.json({message:"deleted branch: "+s});break}case"persistEntry":{const{entry:r,assets:c,options:u}=t.params;if(u.useWorkflow){const t=r.slug,o=u.collectionName,d=n.generateContentKey(o,t),p=n.branchFromContentKey(d);await m(a,l,async()=>{const t=await w(a,p);t?await a.checkout(p):await a.checkoutLocalBranch(p),await(async(e,t)=>{const a=await e.raw(["config","commit.gpgsign"]);try{"true"===a&&await e.addConfig("commit.gpgsign","false"),await e.rebase([t,"--no-verify"])}finally{"true"===a&&await e.addConfig("commit.gpgsign",a)}})(a,l);const o=(await b(a,l,p)).filter(e=>e.binary&&!c.map(e=>e.path).includes(e.path));if(await Promise.all(o.map(t=>s.promises.unlink(i.default.join(e,t.path)))),await g(a,e,r,c,u.commitMessage),!t){const e=n.statusToLabel(u.status);await a.addConfig(y(p),e)}})}else await m(a,l,async()=>{await g(a,e,r,c,u.commitMessage)});o.json({message:"entry persisted"});break}case"updateUnpublishedEntryStatus":{const{collection:e,slug:r,newStatus:i}=t.params,s=n.generateContentKey(e,r),c=n.branchFromContentKey(s),u=n.statusToLabel(i);await a.addConfig(y(c),u),o.json({message:`${l} description was updated to ${u}`});break}case"publishUnpublishedEntry":{const{collection:e,slug:r}=t.params,i=n.generateContentKey(e,r),s=n.branchFromContentKey(i);await(async(e,t,a)=>{const r=await e.raw(["config","commit.gpgsign"]);try{"true"===r&&await e.addConfig("commit.gpgsign","false"),await e.mergeFromTo(t,a)}finally{"true"===r&&await e.addConfig("commit.gpgsign",r)}})(a,s,l),await a.deleteLocalBranch(s),o.json({message:`branch ${s} merged to ${l}`});break}case"getMedia":{const{mediaFolder:r}=t.params,i=await m(a,l,async()=>{const t=await d.listRepoFiles(e,r,"",1);return await Promise.all(t.map(t=>p.readMediaFile(e,t)))});o.json(i);break}case"getMediaFile":{const{path:r}=t.params,i=await m(a,l,()=>p.readMediaFile(e,r));o.json(i);break}case"persistMedia":{const{asset:r,options:{commitMessage:s}}=t.params,n=await m(a,l,async()=>(await d.writeFile(i.default.join(e,r.path),Buffer.from(r.content,r.encoding)),await f(a,s),p.readMediaFile(e,r.path)));o.json(n);break}case"deleteFile":{const{path:r,options:{commitMessage:n}}=t.params;await m(a,l,async()=>{await s.promises.unlink(i.default.join(e,r)),await f(a,n)}),o.json({message:"deleted file "+r});break}case"getDeployPreview":o.json(null);break;default:{const e="Unknown action "+t.action;o.status(422).json({error:e});break}}}catch(e){t.error(`Error handling ${JSON.stringify(r.body)}: ${e.message}`),o.status(500).json({error:"Unknown error"})}}},t.registerMiddleware=async(e,a)=>{const{logger:r}=a,s=i.default.resolve(process.env.GIT_REPO_DIRECTORY||process.cwd());await t.validateRepo({repoPath:s}),e.post("/api/v1",l.joi(t.getSchema({repoPath:s}))),e.post("/api/v1",t.localGitMiddleware({repoPath:s,logger:r})),r.info("Netlify CMS Git Proxy Server configured with "+s)}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.branchFromContentKey=t.contentKeyFromBranch=t.parseContentKey=t.generateContentKey=t.statusToLabel=t.labelToStatus=t.isCMSLabel=t.MERGE_COMMIT_MESSAGE=t.DEFAULT_PR_BODY=t.CMS_BRANCH_PREFIX=void 0,t.CMS_BRANCH_PREFIX="cms",t.DEFAULT_PR_BODY="Automatically generated by Netlify CMS",t.MERGE_COMMIT_MESSAGE="Automatically generated. Merged on Netlify CMS.";t.isCMSLabel=e=>e.startsWith("netlify-cms/"),t.labelToStatus=e=>e.substr("netlify-cms/".length),t.statusToLabel=e=>"netlify-cms/"+e,t.generateContentKey=(e,t)=>`${e}/${t}`,t.parseContentKey=e=>{const t=e.indexOf("/");return{collection:e.substr(0,t),slug:e.substr(t+1)}},t.contentKeyFromBranch=e=>e.substring((t.CMS_BRANCH_PREFIX+"/").length),t.branchFromContentKey=e=>`${t.CMS_BRANCH_PREFIX}/${e}`},function(e,t){e.exports=require("what-the-diff")},function(e,t){e.exports=require("simple-git/promise")},function(e,t){e.exports=require("crypto")},function(e,t,a){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.registerMiddleware=t.getSchema=t.localFsMiddleware=void 0;const i=r(a(0)),s=a(2),n=a(4),o=a(5),l=a(6);t.localFsMiddleware=({repoPath:e,logger:t})=>async function(a,r){try{const{body:t}=a;switch(t.action){case"info":r.json({repo:i.default.basename(e),publish_modes:["simple"],type:"local_fs"});break;case"entriesByFolder":{const a=t.params,{folder:i,extension:s,depth:n}=a,c=await o.listRepoFiles(e,i,s,n).then(t=>l.entriesFromFiles(e,t.map(e=>({path:e}))));r.json(c);break}case"entriesByFiles":{const a=t.params,i=await l.entriesFromFiles(e,a.files);r.json(i);break}case"getEntry":{const a=t.params,[i]=await l.entriesFromFiles(e,[{path:a.path}]);r.json(i);break}case"persistEntry":{const{entry:a,assets:s}=t.params;await o.writeFile(i.default.join(e,a.path),a.raw),await Promise.all(s.map(t=>o.writeFile(i.default.join(e,t.path),Buffer.from(t.content,t.encoding)))),a.newPath&&await o.move(i.default.join(e,a.path),i.default.join(e,a.newPath)),r.json({message:"entry persisted"});break}case"getMedia":{const{mediaFolder:a}=t.params,i=await o.listRepoFiles(e,a,"",1),s=await Promise.all(i.map(t=>l.readMediaFile(e,t)));r.json(s);break}case"getMediaFile":{const{path:a}=t.params,i=await l.readMediaFile(e,a);r.json(i);break}case"persistMedia":{const{asset:a}=t.params;await o.writeFile(i.default.join(e,a.path),Buffer.from(a.content,a.encoding));const s=await l.readMediaFile(e,a.path);r.json(s);break}case"deleteFile":{const{path:a}=t.params;await o.deleteFile(e,a),r.json({message:"deleted file "+a});break}case"getDeployPreview":r.json(null);break;default:{const e="Unknown action "+t.action;r.status(422).json({error:e});break}}}catch(e){t.error(`Error handling ${JSON.stringify(a.body)}: ${e.message}`),r.status(500).json({error:"Unknown error"})}},t.getSchema=({repoPath:e})=>s.defaultSchema({path:n.pathTraversal(e)}),t.registerMiddleware=async(e,a)=>{const{logger:r}=a,n=i.default.resolve(process.env.GIT_REPO_DIRECTORY||process.cwd());e.post("/api/v1",s.joi(t.getSchema({repoPath:n}))),e.post("/api/v1",t.localFsMiddleware({repoPath:n,logger:r})),r.info("Netlify CMS File System Proxy Server configured with "+n)}},function(e,t,a){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createLogger=void 0;const i=r(a(18)),{combine:s,colorize:n,simple:o}=i.default.format;t.createLogger=({level:e})=>i.default.createLogger({level:e,format:s(n(),o()),transports:[new i.default.transports.Console]})},function(e,t){e.exports=require("winston")},function(e,t,a){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),a(20).config();const i=r(a(7)),s=a(8),n=a(11),o=a(16),l=a(17),c=i.default(),u=process.env.PORT||8081,d=process.env.LOG_LEVEL||"info";(async()=>{const e=l.createLogger({level:d}),t={logger:e};s.registerCommonMiddlewares(c,t);try{const e=process.env.MODE||"fs";if("fs"===e)o.registerMiddleware(c,t);else{if("git"!==e)throw new Error(`Unknown proxy mode '${e}'`);n.registerMiddleware(c,t)}}catch(t){e.error(t.message),process.exit(1)}c.listen(u,()=>{e.info("Netlify CMS Proxy Server listening on port "+u)})})()},function(e,t){e.exports=require("dotenv")}]);
//# sourceMappingURL=index.js.map